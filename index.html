<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Marketing Hub</title>
    <!-- Add Icon Links for Mobile Home Screen -->
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800;900&family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        h1, h2, h3, .brand-font { font-family: 'Montserrat', sans-serif; }
        
        /* Desktop scrollbar */
        @media (min-width: 768px) {
            .controls-panel::-webkit-scrollbar { width: 6px; }
            .controls-panel::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        }
        
        .canvas-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .input-group { transition: all 0.3s ease-in-out; }
        .hidden-group { display: none; }
        
        /* Loading & Error Overlays */
        .status-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            text-align: center;
            padding: 20px;
        }

        /* Modal for Saving Images */
        #saveModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #saveModal.active {
            visibility: visible;
            opacity: 1;
        }
        #finalImage {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .hidden { display: none !important; }

        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 150;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row md:h-screen md:overflow-hidden bg-gray-100">

    <!-- SAVE MODAL (Popup for Mobile) -->
    <div id="saveModal">
        <div class="bg-white p-4 rounded-lg w-full max-w-sm text-center mb-4 relative">
            <h3 class="font-bold text-gray-800 text-lg mb-1">Save Your Image</h3>
            <p class="text-sm text-gray-500 mb-3">Long Press (Tap & Hold) the image below, then select <strong>"Save to Photos"</strong></p>
            <button id="closeModalBtn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <img id="finalImage" src="" alt="Generated Post">
    </div>

    <!-- LEFT PANEL: CONTROLS -->
    <div class="w-full md:w-96 bg-white flex flex-col z-10 shadow-lg md:h-full md:border-r border-gray-200 order-2 md:order-1">
        
        <div class="p-5 border-b border-gray-100 bg-slate-50 flex justify-between items-center sticky top-0 z-20 md:static">
            <div>
                <h1 class="text-xl font-bold text-slate-800"><i class="fas fa-layer-group mr-2 text-blue-900"></i>Team Marketing Hub</h1>
                <p class="text-xs text-gray-500 mt-1">Mobile V4.5 - Share Fix</p>
            </div>
            <button onclick="document.getElementById('preview-section').scrollIntoView({behavior: 'smooth'})" class="md:hidden text-blue-900 text-sm font-bold border border-blue-200 p-2 rounded bg-white">
                <i class="fas fa-eye"></i> View
            </button>
        </div>

        <div class="flex-1 p-5 controls-panel space-y-6 md:overflow-y-auto">
            
            <!-- SECTION: TEMPLATE SELECTOR -->
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <label class="block text-xs font-bold text-blue-900 mb-1 uppercase tracking-wider">Select Campaign</label>
                <div class="relative">
                    <select id="templateSelect" class="w-full p-2 pl-9 border border-blue-200 rounded text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-900 focus:border-blue-900 appearance-none bg-white outline-none">
                        <option value="purchase">Purchase Closing (Social)</option>
                        <option value="refinance">Refinance Success (Social)</option>
                        <option value="openhouse">Open House (Social)</option>
                        <option value="flyer">Open House Flyer (Print 8.5x11)</option>
                    </select>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-blue-900">
                        <i class="fas fa-magic"></i>
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- SECTION: AGENT INFO -->
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">My Profile</h3>
                    <button id="clearProfileBtn" class="text-[10px] text-red-400 hover:text-red-600 underline cursor-pointer">Reset Fields</button>
                </div>

                <!-- TEAM HUB -->
                <div class="bg-indigo-50 p-2 rounded border border-indigo-100 mb-2 shadow-sm">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-indigo-900 uppercase">Team Hub (Loan Officers)</label>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <select id="savedAgentSelect" class="flex-1 text-xs border border-gray-300 rounded p-1.5 bg-white outline-none text-gray-700">
                            <option value="">Select a team member...</option>
                        </select>
                        <button id="deleteAgentBtn" class="hidden text-xs text-red-500 hover:bg-red-50 p-1.5 rounded border border-transparent hover:border-red-200" title="Delete from Team Hub">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <button id="saveAgentBtn" class="w-full text-xs bg-indigo-100 text-indigo-800 font-semibold py-1.5 rounded hover:bg-indigo-200 border border-indigo-200 transition-colors">
                        <i class="fas fa-save mr-1"></i> Save Current Profile to Hub
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">My Headshot</label>
                        <input type="file" id="agentPhotoInput" accept="image/*" class="w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-[10px] text-green-600 mt-1 hidden" id="agentPhotoSaved"><i class="fas fa-check-circle"></i> Loaded</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Company Logo</label>
                        <input type="file" id="logoInput" accept="image/*" class="w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-[10px] text-green-600 mt-1 hidden" id="logoSaved"><i class="fas fa-check-circle"></i> Loaded</p>
                    </div>
                </div>

                <input type="text" id="agentName" value="Ben Harman" class="w-full p-2 border rounded text-sm font-bold bg-gray-50 text-gray-700 border-gray-200 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="Your Name">
                <input type="text" id="agentTitle" value="Mortgage Loan Originator" class="w-full p-2 border rounded text-sm bg-gray-50 text-gray-700 border-gray-200 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="Your Title">
                <input type="text" id="agentContact" value="(419)-266-6229 | NMLS# 2599175" class="w-full p-2 border rounded text-sm bg-gray-50 text-gray-700 border-gray-200 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="Contact Info">
                
                <!-- NEW SOCIAL HANDLES -->
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <input type="text" id="socialInsta" class="w-full p-1.5 border rounded text-xs text-gray-700 border-gray-200 outline-none" placeholder="@Instagram">
                    <input type="text" id="socialFb" class="w-full p-1.5 border rounded text-xs text-gray-700 border-gray-200 outline-none" placeholder="/Facebook">
                    <input type="text" id="socialLi" class="w-full p-1.5 border rounded text-xs text-gray-700 border-gray-200 outline-none" placeholder="/LinkedIn">
                </div>

                <div class="bg-yellow-50 p-2 rounded border border-yellow-200 mt-2">
                    <label class="block text-[10px] font-bold text-yellow-800 mb-1 uppercase">Compliance Info</label>
                    <input type="text" id="companyNmls" value="Company NMLS# 2327585" class="w-full p-1.5 border rounded text-xs text-gray-700 border-gray-200 focus:border-blue-500 outline-none" placeholder="Company NMLS ID">
                </div>
            </div>

            <hr class="border-gray-100">

            <!-- SECTION: MAIN CONTENT -->
            <div class="space-y-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Post Content</h3>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1" id="mainPhotoLabel">Main Photo (Clients/House)</label>
                    <input type="file" id="mainPhotoInput" accept="image/*" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Status Banner</label>
                    <input type="text" id="statusText" value="JUST CLOSED!" class="w-full p-2 border rounded text-sm font-bold text-green-700 border-gray-300 focus:border-green-600 outline-none" placeholder="e.g. JUST CLOSED!">
                </div>

                <div id="storyInputGroup" class="input-group">
                    <label class="block text-xs font-medium text-gray-700 mb-1" id="storyLabel">Borrower Story</label>
                    <textarea id="borrowerStory" rows="4" class="w-full p-2 border rounded text-sm border-gray-300 focus:border-blue-500 outline-none" placeholder="Tell the story...">Another smooth closing! We successfully navigated a complex self-employed application and got the Smith family into their dream home in just 28 days.</textarea>
                </div>

                <div id="openHouseDescGroup" class="input-group hidden-group">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Property Description</label>
                    <textarea id="propertyDesc" rows="4" class="w-full p-2 border rounded text-sm border-gray-300 focus:border-blue-500 outline-none" placeholder="Beautiful 4 bed, 3 bath...">Stunning turn-key home in the heart of the city! Features a gourmet kitchen, hardwood floors, and a spacious backyard oasis.</textarea>
                </div>
            </div>
            
            <!-- SECTION: MORTGAGE CALCULATOR (FLYER ONLY) -->
            <div id="calcInputs" class="space-y-3 bg-green-50 p-3 rounded-lg border border-green-200 hidden-group">
                <h3 class="text-xs font-bold text-green-800 uppercase tracking-wider"><i class="fas fa-calculator mr-1"></i> Financing Scenarios</h3>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-600">List Price ($)</label>
                        <input type="number" id="calcPrice" value="450000" class="w-full p-1.5 border rounded text-xs">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-600">HOA (Monthly)</label>
                        <input type="number" id="calcHoa" value="50" class="w-full p-1.5 border rounded text-xs">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-600">Tax (Yearly)</label>
                        <input type="number" id="calcTax" value="5000" class="w-full p-1.5 border rounded text-xs">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-600">Ins (Yearly)</label>
                        <input type="number" id="calcIns" value="1200" class="w-full p-1.5 border rounded text-xs">
                    </div>
                </div>

                <div class="border-t border-green-200 pt-2 mt-1">
                     <p class="text-[10px] font-bold text-green-800 mb-1">Option 1 (e.g. Conventional)</p>
                     <div class="grid grid-cols-3 gap-2">
                         <input type="text" id="sc1Label" value="Conventional" class="col-span-1 p-1.5 border rounded text-xs" placeholder="Label">
                         <input type="number" id="sc1Down" value="20" class="col-span-1 p-1.5 border rounded text-xs" placeholder="Down %">
                         <input type="number" id="sc1Rate" value="6.5" class="col-span-1 p-1.5 border rounded text-xs" placeholder="Rate %">
                     </div>
                </div>

                <div class="border-t border-green-200 pt-2 mt-1">
                     <p class="text-[10px] font-bold text-green-800 mb-1">Option 2 (e.g. FHA)</p>
                     <div class="grid grid-cols-3 gap-2">
                         <input type="text" id="sc2Label" value="FHA" class="col-span-1 p-1.5 border rounded text-xs" placeholder="Label">
                         <input type="number" id="sc2Down" value="3.5" class="col-span-1 p-1.5 border rounded text-xs" placeholder="Down %">
                         <input type="number" id="sc2Rate" value="5.99" class="col-span-1 p-1.5 border rounded text-xs" placeholder="Rate %">
                     </div>
                </div>
                
                <div class="mt-2">
                    <label class="block text-[10px] font-bold text-gray-400">Compliance Disclaimer</label>
                    <textarea id="calcDisclaimer" rows="2" class="w-full p-1.5 border rounded text-[10px] text-gray-500">For informational purposes only. Payments are estimates and include principal, interest, taxes, and insurance. Actual rate and payment may vary. Not a credit commitment.</textarea>
                </div>
            </div>

            <hr class="border-gray-100">

            <!-- SECTION: DYNAMIC SECONDARY BOX -->
            <div id="secondarySection" class="space-y-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                
                <div id="partnerInputs" class="input-group">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Referral Partner</h3>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="partnerToggle" class="sr-only peer" checked>
                            <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-900"></div>
                        </label>
                    </div>

                    <!-- PARTNER HUB -->
                    <div class="bg-white p-2 rounded border border-blue-100 mb-3 shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-blue-900 uppercase">Partner Hub</label>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <select id="savedPartnerSelect" class="flex-1 text-xs border border-gray-300 rounded p-1.5 bg-gray-50 outline-none text-gray-700">
                                <option value="">Select a saved partner...</option>
                            </select>
                            <button id="deletePartnerBtn" class="hidden text-xs text-red-500 hover:bg-red-50 p-1.5 rounded border border-transparent hover:border-red-200" title="Delete from Hub">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <button id="savePartnerBtn" class="w-full text-xs bg-blue-50 text-blue-800 font-semibold py-1.5 rounded hover:bg-blue-100 border border-blue-200 transition-colors">
                            <i class="fas fa-save mr-1"></i> Save Current to Hub
                        </button>
                    </div>
                    
                    <div id="partnerControls" class="space-y-2 transition-all duration-300">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] font-medium text-gray-700 mb-1">Headshot</label>
                                <input type="file" id="partnerPhotoInput" accept="image/*" class="w-full text-[10px] text-slate-500 file:mr-1 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <div>
                                <label class="block text-[10px] font-medium text-gray-700 mb-1">Logo</label>
                                <input type="file" id="partnerLogoInput" accept="image/*" class="w-full text-[10px] text-slate-500 file:mr-1 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                        </div>
                        
                        <input type="text" id="partnerName" value="Sarah Chang" class="w-full p-2 border rounded text-sm font-bold border-gray-300 outline-none" placeholder="Partner Name">
                        <input type="text" id="partnerTitle" value="Realtor | City Realty" class="w-full p-2 border rounded text-sm border-gray-300 outline-none" placeholder="Partner Title/Company">
                        <input type="text" id="partnerContact" value="555.123.4567 | sarah@example.com" class="w-full p-2 border rounded text-sm border-gray-300 outline-none" placeholder="Partner Phone/Email">
                        <input type="text" id="partnerShoutout" value="Huge thanks to Sarah for trusting us with her clients!" class="w-full p-2 border rounded text-sm border-gray-300 outline-none" placeholder="Short shoutout (Purchase only)">
                    </div>
                </div>

                <div id="refiInputs" class="input-group hidden-group">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Savings Breakdown</h3>
                    <div class="space-y-2">
                         <input type="text" id="refiTitle" value="MONTHLY SAVINGS" class="w-full p-2 border rounded text-sm font-bold border-gray-300 outline-none" placeholder="Header (e.g. Monthly Savings)">
                         <textarea id="refiDetails" rows="3" class="w-full p-2 border rounded text-sm border-gray-300 outline-none" placeholder="Details...">We lowered their rate by 1.5% and saved them $450 every single month!</textarea>
                    </div>
                </div>

                <div id="openHouseInputs" class="input-group hidden-group">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Event Details</h3>
                    <div class="space-y-2">
                        <input type="text" id="ohDate" value="Sunday, Oct 24th" class="w-full p-2 border rounded text-sm font-bold border-gray-300 outline-none" placeholder="Date">
                        <input type="text" id="ohTime" value="1:00 PM - 3:00 PM" class="w-full p-2 border rounded text-sm border-gray-300 outline-none" placeholder="Time">
                        <input type="text" id="ohAddress" value="123 Maple Avenue, Springfield" class="w-full p-2 border rounded text-sm border-gray-300 outline-none" placeholder="Address">
                    </div>
                </div>

            </div>

            <div class="space-y-3 pt-2">
                 <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Brand Theme</h3>
                 <div class="flex gap-4">
                     <div class="flex-1">
                         <label class="block text-xs text-gray-500 mb-1">Primary (Navy)</label>
                         <input type="color" id="primaryColor" value="#0d3b66" class="h-8 w-full cursor-pointer rounded border border-gray-200">
                     </div>
                     <div class="flex-1">
                         <label class="block text-xs text-gray-500 mb-1">Secondary (Grey)</label>
                         <input type="color" id="secondaryColor" value="#8d99ae" class="h-8 w-full cursor-pointer rounded border border-gray-200">
                     </div>
                 </div>
            </div>

            <!-- SECTION: SOCIAL SHARE -->
            <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                <h3 class="text-xs font-bold text-purple-900 uppercase tracking-wider"><i class="fas fa-share-alt mr-1"></i> Social Post</h3>
                <textarea id="socialCaption" rows="3" class="w-full p-2 border rounded text-sm border-purple-200 focus:border-purple-500 outline-none" placeholder="Draft your social media caption here..."></textarea>
                <button id="copyCaptionBtn" class="w-full text-xs text-purple-700 font-semibold py-1.5 rounded hover:bg-purple-100 border border-purple-200 transition-colors">
                    <i class="fas fa-copy mr-1"></i> Copy Caption to Clipboard
                </button>
            </div>

        </div>
        
        <div class="p-4 border-t border-gray-200 bg-white space-y-3 sticky bottom-0 z-20 md:static">
            <!-- Share Button Group -->
            <div class="flex gap-2">
                <button id="shareBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-2 rounded-lg shadow transition-colors flex items-center justify-center gap-1 text-sm">
                    <i class="fas fa-share-from-square"></i> Share to Apps
                </button>
                <button id="downloadBtn" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-2 rounded-lg shadow transition-colors flex items-center justify-center gap-1 text-sm">
                    <i class="fas fa-download"></i> Download Image
                </button>
            </div>
            
            <button id="saveToolBtn" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-semibold py-2 px-4 rounded-lg border border-slate-300 transition-colors flex items-center justify-center gap-2">
                <i class="fas fa-save"></i> Save & Download Tool
            </button>
        </div>
    </div>

    <!-- RIGHT PANEL: PREVIEW -->
    <div id="preview-section" class="flex-1 bg-gray-200 flex items-center justify-center p-4 md:p-10 order-1 md:order-2 md:h-full md:overflow-auto relative min-h-[400px]">
        <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 20px 20px;"></div>
        
        <!-- The Canvas -->
        <canvas id="postCanvas" width="1080" height="1080" class="w-full max-w-[500px] md:max-w-full h-auto shadow-2xl bg-white rounded-sm">
            Your browser does not support the Canvas API. Please open in Chrome or Safari.
        </canvas>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="status-overlay">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-900 mb-4"></i>
            <h2 class="text-xl font-bold text-slate-700">Loading App...</h2>
            <p class="text-sm text-gray-500 mt-2">Initializing...</p>
        </div>
        
        <!-- Error Overlay -->
        <div id="error-overlay" class="status-overlay hidden">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h2 class="text-xl font-bold text-slate-700">Security Restriction</h2>
            <p class="text-sm text-gray-500 mt-2 max-w-xs mx-auto">
                App blocked. Please try opening in a different browser.
            </p>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast">Notification Message</div>

<script>
    // --- Global Error Handler ---
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("Global Error Caught:", message);
        // Force hide loader on error
        const loader = document.getElementById('loading-overlay');
        if(loader) loader.classList.add('hidden');
    };

    (function() {
        // --- SAFE STORAGE WRAPPER ---
        const safeStorage = {
            getItem: function(key) {
                try { return localStorage.getItem(key); } catch (e) { return null; }
            },
            setItem: function(key, value) {
                try { localStorage.setItem(key, value); } catch (e) {}
            },
            removeItem: function(key) {
                try { localStorage.removeItem(key); } catch (e) {}
            }
        };

        // --- CONFIGURATION ---
        const canvas = document.getElementById('postCanvas');
        const ctx = canvas.getContext('2d');
        const saveModal = document.getElementById('saveModal');
        const finalImage = document.getElementById('finalImage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        // --- BASE64 PLACEHOLDERS (No Internet Required) ---
        const DATA_URI_GRAY = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNjYmQ1ZTEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9ImFyaWFsIiBmb250LXNpemU9IjMwIiBmaWxsPSIjZmZmIiBkeT0iLjNlbSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UGhvdG88L3RleHQ+PC9zdmc+';
        const DATA_URI_NAVY = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiMwZDNiNjYiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9ImFyaWFsIiBmb250LXNpemU9IjMwIiBmaWxsPSIjZmZmIiBkeT0iLjNlbSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QkguPC90ZXh0Pjwvc3ZnPg==';

        const SAVED_AGENT_PHOTO_SRC = ''; 
        const SAVED_LOGO_SRC = '';      
        
        // Use Base64 defaults if no saved image
        const defaultAgentPhoto = SAVED_AGENT_PHOTO_SRC || DATA_URI_NAVY;
        const defaultPartnerPhoto = DATA_URI_GRAY;
        
        const state = {
            template: 'purchase',
            agentName: document.getElementById('agentName').value,
            agentTitle: document.getElementById('agentTitle').value,
            agentContact: document.getElementById('agentContact').value,
            companyNmls: document.getElementById('companyNmls').value,
            socialInsta: document.getElementById('socialInsta').value,
            socialFb: document.getElementById('socialFb').value,
            socialLi: document.getElementById('socialLi').value,
            statusText: document.getElementById('statusText').value,
            borrowerStory: document.getElementById('borrowerStory').value,
            partnerEnabled: true,
            partnerName: document.getElementById('partnerName').value,
            partnerTitle: document.getElementById('partnerTitle').value,
            partnerContact: document.getElementById('partnerContact').value,
            partnerShoutout: document.getElementById('partnerShoutout').value,
            refiTitle: document.getElementById('refiTitle').value,
            refiDetails: document.getElementById('refiDetails').value,
            propertyDesc: document.getElementById('propertyDesc').value,
            ohDate: document.getElementById('ohDate').value,
            ohTime: document.getElementById('ohTime').value,
            ohAddress: document.getElementById('ohAddress').value,
            primaryColor: document.getElementById('primaryColor').value,
            secondaryColor: document.getElementById('secondaryColor').value,
            // Calculator State
            calcPrice: 450000,
            calcHoa: 50,
            calcTax: 5000,
            calcIns: 1200,
            sc1Label: 'Conventional', sc1Down: 20, sc1Rate: 6.5,
            sc2Label: 'FHA', sc2Down: 3.5, sc2Rate: 5.99,
            calcDisclaimer: document.getElementById('calcDisclaimer').value,
            socialCaption: '', // for posting
            
            images: { agent: null, main: null, partner: null, partnerLogo: null, logo: null }
        };

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- ROBUST IMAGE LOADER (With Timeout) ---
        function loadImage(src) {
            return new Promise(resolve => {
                if (!src || src.length < 10) return resolve(null);
                
                const img = new Image();
                img.crossOrigin = "anonymous"; 
                
                let isResolved = false;
                
                img.onload = () => {
                    if(!isResolved) { isResolved = true; resolve(img); }
                };
                
                img.onerror = () => {
                    if (img.crossOrigin === "anonymous") {
                        img.crossOrigin = null;
                        img.src = src; // Retry
                    } else {
                        if(!isResolved) { isResolved = true; resolve(null); }
                    }
                };

                setTimeout(() => {
                    if(!isResolved) { 
                        isResolved = true; 
                        resolve(null); 
                    }
                }, 1500);

                img.src = src;
            });
        }

        function wrapText(context, text, x, y, maxWidth, initialFontSize, fontFace, maxLines) {
            context.font = `${initialFontSize}px ${fontFace}`;
            const words = text.split(' ');
            let lines = [];
            let line = '';

            for(let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            if (maxLines && lines.length > maxLines) {
                const newFontSize = initialFontSize - 2;
                if (newFontSize > 10) { 
                    return wrapText(context, text, x, y, maxWidth, newFontSize, fontFace, maxLines);
                }
            }

            const lineHeight = initialFontSize * 1.4;
            for(let k = 0; k < lines.length; k++) {
                context.fillText(lines[k], x, y + (k * lineHeight));
            }
            return lines.length * lineHeight;
        }

        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.beginPath();
            this.moveTo(x+r, y);
            this.arcTo(x+w, y,   x+w, y+h, r);
            this.arcTo(x+w, y+h, x,   y+h, r);
            this.arcTo(x,   y+h, x,   y,   r);
            this.arcTo(x,   y,   x+w, y,   r);
            this.closePath();
            return this;
        }

        function drawImageCover(ctx, img, x, y, w, h) {
            const sW = img.width;
            const sH = img.height;
            const targetRatio = w / h;
            const sourceRatio = sW / sH;
            let drawW, drawH, startX, startY;

            if (sourceRatio > targetRatio) {
                drawH = sH;
                drawW = sH * targetRatio;
                startX = (sW - drawW) / 2;
                startY = 0;
            } else {
                drawW = sW;
                drawH = sW / targetRatio;
                startX = 0;
                startY = (sH - drawH) / 2;
            }
            ctx.drawImage(img, startX, startY, drawW, drawH, x, y, w, h);
        }

        // --- MORTGAGE CALCULATOR ---
        function calculateMortgage(price, downPercent, rate, taxYr, insYr, hoaMo) {
            const principal = price * (1 - (downPercent / 100));
            const monthlyRate = rate / 100 / 12;
            const numPayments = 30 * 12; // 30 yr default
            
            // P&I
            let pi = 0;
            if (rate > 0) {
                pi = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            } else {
                pi = principal / numPayments;
            }
            
            const taxes = taxYr / 12;
            const insurance = insYr / 12;
            const total = pi + taxes + insurance + hoaMo;
            
            return {
                downAmt: price * (downPercent / 100),
                loanAmt: principal,
                pi: pi,
                taxes: taxes,
                ins: insurance,
                hoa: hoaMo,
                total: total
            };
        }

        function formatCurrency(num) {
            return "$" + Math.round(num).toLocaleString();
        }

        async function drawPost() {
            // Resize Canvas based on Template
            const isFlyer = state.template === 'flyer';
            const targetW = isFlyer ? 1275 : 1080;
            const targetH = isFlyer ? 1650 : 1080;
            
            if (canvas.width !== targetW || canvas.height !== targetH) {
                canvas.width = targetW;
                canvas.height = targetH;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const bgGrad = ctx.createLinearGradient(0, 0, 0, targetH);
            bgGrad.addColorStop(0, "#f8fafc");
            bgGrad.addColorStop(1, "#e2e8f0");
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, targetW, targetH);

            // -- LAYOUT CONFIG --
            const W = targetW;
            const H = targetH;
            const isOpenHouse = state.template === 'openhouse';

            // --- HEADER ---
            let bannerY = 0;
            let mainImgY = 0;
            let mainImgH = 0;

            if (isFlyer) {
                // FLYER HEADER (Logos top L/R, Title Center)
                const headerH = 180;
                
                // Partner Logo
                if (state.images.partnerLogo) {
                    const plImg = state.images.partnerLogo;
                    const r = Math.min(250/plImg.width, 100/plImg.height);
                    ctx.drawImage(plImg, 60, 50, plImg.width*r, plImg.height*r);
                }

                // Company Logo
                if (state.images.logo) {
                    const lImg = state.images.logo;
                    const r = Math.min(280/lImg.width, 100/lImg.height);
                    ctx.drawImage(lImg, W - 60 - (lImg.width*r), 50, lImg.width*r, lImg.height*r);
                } else {
                    ctx.fillStyle = "#cbd5e1";
                    ctx.roundRect(W - 280, 50, 220, 80, 5); ctx.fill();
                    ctx.fillStyle = "#64748b"; ctx.font = "bold 20px Roboto"; ctx.textAlign = "center";
                    ctx.fillText("Upload Logo", W - 170, 95);
                }

                // Center Title
                ctx.fillStyle = state.primaryColor;
                ctx.font = "900 70px Montserrat";
                ctx.textAlign = "center";
                ctx.fillText("OPEN HOUSE", W/2, 110);
                
                // Main Photo
                mainImgY = 180;
                mainImgH = 500;
                
                ctx.save();
                ctx.roundRect(60, mainImgY, W - 120, mainImgH, 10);
                ctx.clip();
                if (state.images.main) drawImageCover(ctx, state.images.main, 60, mainImgY, W - 120, mainImgH);
                else { ctx.fillStyle = "#cbd5e1"; ctx.fillRect(60, mainImgY, W - 120, mainImgH); }
                ctx.restore();

                // Property Details (Address & Desc)
                ctx.textAlign = "left";
                const contentY = mainImgY + mainImgH + 50;
                
                // Icon + Address
                ctx.font = "30px FontAwesome";
                ctx.fillStyle = "#ea580c";
                ctx.fillText("\uf3c5", 60, contentY);
                
                ctx.font = "700 36px Montserrat";
                ctx.fillStyle = "#1e293b";
                ctx.fillText(state.ohAddress, 110, contentY);
                
                // Time
                ctx.font = "30px FontAwesome";
                ctx.fillStyle = "#ea580c";
                ctx.fillText("\uf017", 60, contentY + 50);
                
                ctx.font = "500 32px Roboto";
                ctx.fillStyle = "#334155";
                const timeStr = `${state.ohDate}  |  ${state.ohTime}`;
                ctx.fillText(timeStr, 110, contentY + 50);

                // Description Paragraph
                ctx.font = "26px Roboto";
                ctx.fillStyle = "#475569";
                wrapText(ctx, state.propertyDesc, 60, contentY + 110, W - 120, 26, "Roboto", 4);

                // --- FINANCING TABLE (CALCULATOR) ---
                const calcY = contentY + 280;
                const calcBoxH = 420;
                
                // Background Box
                ctx.fillStyle = "#FFFFFF";
                ctx.shadowColor = "rgba(0,0,0,0.05)"; ctx.shadowBlur = 10;
                ctx.roundRect(60, calcY, W - 120, calcBoxH, 15);
                ctx.fill(); ctx.shadowBlur = 0;
                
                // Header Bar
                ctx.fillStyle = state.primaryColor;
                ctx.roundRect(60, calcY, W - 120, 60, {tl:15, tr:15, bl:0, br:0});
                ctx.fill();
                
                ctx.fillStyle = "#FFFFFF";
                ctx.font = "700 30px Montserrat";
                ctx.textAlign = "center";
                ctx.fillText(`FINANCING OPTIONS  |  LIST PRICE: ${formatCurrency(state.calcPrice)}`, W/2, calcY + 40);

                // CALCULATIONS
                const res1 = calculateMortgage(state.calcPrice, state.sc1Down, state.sc1Rate, state.calcTax, state.calcIns, state.calcHoa);
                const res2 = calculateMortgage(state.calcPrice, state.sc2Down, state.sc2Rate, state.calcTax, state.calcIns, state.calcHoa);

                // TABLE DRAWING - ADJUSTED SPACING
                const col1X = 90;
                const col2X = 720;
                const col3X = 1020;
                const rowStart = calcY + 110;
                const rowH = 45;

                ctx.font = "700 24px Montserrat";
                ctx.fillStyle = "#1e293b";
                ctx.textAlign = "left";  ctx.fillText("Down Payment", col1X, rowStart);
                ctx.fillText("Interest Rate", col1X, rowStart + rowH);
                ctx.fillText("Principal & Int.", col1X, rowStart + rowH*2);
                ctx.fillText("Tax + Ins + HOA", col1X, rowStart + rowH*3);
                
                ctx.font = "900 26px Montserrat";
                ctx.fillStyle = state.primaryColor;
                ctx.fillText("EST. PAYMENT", col1X, rowStart + rowH*4 + 10);

                // COL 2 (SCENARIO 1)
                ctx.textAlign = "center";
                ctx.fillStyle = state.primaryColor; ctx.font = "800 26px Montserrat";
                ctx.fillText(state.sc1Label, col2X, rowStart - 35); // Header

                ctx.fillStyle = "#334155"; ctx.font = "500 24px Roboto";
                ctx.fillText(`${state.sc1Down}% (${formatCurrency(res1.downAmt)})`, col2X, rowStart);
                ctx.fillText(`${state.sc1Rate}%`, col2X, rowStart + rowH);
                ctx.fillText(formatCurrency(res1.pi), col2X, rowStart + rowH*2);
                ctx.fillText(formatCurrency(res1.taxes + res1.ins + res1.hoa), col2X, rowStart + rowH*3);
                
                ctx.font = "900 32px Montserrat"; ctx.fillStyle = "#15803d"; // Green
                ctx.fillText(formatCurrency(res1.total), col2X, rowStart + rowH*4 + 10);

                // COL 3 (SCENARIO 2)
                ctx.fillStyle = state.primaryColor; ctx.font = "800 26px Montserrat";
                ctx.fillText(state.sc2Label, col3X, rowStart - 35); // Header

                ctx.fillStyle = "#334155"; ctx.font = "500 24px Roboto";
                ctx.fillText(`${state.sc2Down}% (${formatCurrency(res2.downAmt)})`, col3X, rowStart);
                ctx.fillText(`${state.sc2Rate}%`, col3X, rowStart + rowH);
                ctx.fillText(formatCurrency(res2.pi), col3X, rowStart + rowH*2);
                ctx.fillText(formatCurrency(res2.taxes + res2.ins + res2.hoa), col3X, rowStart + rowH*3);
                
                ctx.font = "900 32px Montserrat"; ctx.fillStyle = "#15803d"; 
                ctx.fillText(formatCurrency(res2.total), col3X, rowStart + rowH*4 + 10);

                // Disclaimer
                ctx.font = "italic 16px Roboto";
                ctx.fillStyle = "#94a3b8";
                ctx.textAlign = "center";
                wrapText(ctx, state.calcDisclaimer, W/2, calcY + calcBoxH - 30, W - 140, 16, "italic Roboto", 2);

            } else {
                // --- STANDARD SOCIAL LAYOUT (SQUARE) ---
                mainImgY = 170; 
                mainImgH = 360; 
                const bannerH = 90;
                bannerY = mainImgY + mainImgH - (bannerH / 2); 

                ctx.save();
                ctx.roundRect(40, mainImgY, 1000, mainImgH, 20); 
                ctx.clip();
                if (state.images.main) drawImageCover(ctx, state.images.main, 40, mainImgY, 1000, mainImgH);
                else { ctx.fillStyle = "#cbd5e1"; ctx.fillRect(40, mainImgY, 1000, mainImgH); ctx.fillStyle = "#64748b"; ctx.textAlign = "center"; ctx.fillText("Upload Photo", 540, mainImgY + (mainImgH/2)); }
                ctx.restore();

                // HEADER LOGIC (Square)
                if (isOpenHouse) {
                    if (state.images.partnerLogo) {
                        const plImg = state.images.partnerLogo;
                        const r = Math.min(260/plImg.width, 100/plImg.height);
                        ctx.drawImage(plImg, 40, 40, plImg.width*r, plImg.height*r);
                    }
                    if (state.images.logo) {
                        const lImg = state.images.logo;
                        const r = Math.min(260/lImg.width, 100/lImg.height);
                        ctx.drawImage(lImg, 1040 - (lImg.width*r), 40, lImg.width*r, lImg.height*r);
                    } else {
                        ctx.textAlign = "right"; ctx.fillStyle = "#cbd5e1"; ctx.roundRect(1040 - 200, 50, 200, 60, 5); ctx.fill(); ctx.fillStyle = "#64748b"; ctx.font = "bold 20px Roboto"; ctx.fillText("Upload Logo", 1030, 88);
                    }
                    ctx.fillStyle = state.primaryColor; ctx.font = "900 60px Montserrat"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    let hTxt = state.statusText.toUpperCase(); if(hTxt.length>15) ctx.font="800 45px Montserrat";
                    ctx.fillText(hTxt, 540, 90);
                } else {
                    ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 15;
                    const gG = ctx.createLinearGradient(40, bannerY, 1040, bannerY); gG.addColorStop(0, "#ca8a04"); gG.addColorStop(0.5, "#facc15"); gG.addColorStop(1, "#ca8a04");
                    ctx.fillStyle = gG; ctx.roundRect(540 - 300, bannerY, 600, bannerH, 10); ctx.fill(); ctx.shadowBlur = 0; 
                    ctx.fillStyle = "#FFFFFF"; ctx.font = "900 60px Montserrat"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText(state.statusText.toUpperCase(), 540, bannerY + (bannerH/2) + 5);

                    ctx.textAlign = "right"; ctx.fillStyle = state.primaryColor; ctx.font = "800 50px Montserrat"; 
                    ctx.fillText(state.agentName.toUpperCase(), 1040, 85);
                    ctx.fillStyle = state.secondaryColor; ctx.font = "500 28px Montserrat";
                    ctx.fillText(state.agentTitle.toUpperCase(), 1040, 125);
                    if (state.images.logo) {
                        const lImg = state.images.logo; const r = Math.min(320/lImg.width, 110/lImg.height);
                        ctx.drawImage(lImg, 40, 40, lImg.width*r, lImg.height*r);
                    } else {
                        ctx.textAlign = "left"; ctx.fillStyle = "#cbd5e1"; ctx.roundRect(40, 50, 200, 60, 5); ctx.fill(); ctx.fillStyle = "#64748b"; ctx.font = "bold 20px Roboto"; ctx.fillText("Upload Logo", 55, 88);
                    }
                }

                // CONTENT BOX (Square)
                const contentStart = bannerY + 90 + 40; 
                ctx.fillStyle = "#FFFFFF"; ctx.shadowColor = "rgba(0,0,0,0.05)"; ctx.shadowBlur = 10;
                ctx.roundRect(40, contentStart, 480, 300, 15); ctx.fill(); ctx.shadowBlur = 0;
                ctx.fillStyle = state.primaryColor; ctx.textAlign = "left"; ctx.font = "700 28px Montserrat";
                let b1T = "BORROWER SUCCESS"; let b1Txt = state.borrowerStory;
                if (state.template === 'openhouse') { b1T = "PROPERTY DETAILS"; b1Txt = state.propertyDesc; }
                else if (state.template === 'refinance') { b1T = "FINANCIAL GOAL"; b1Txt = state.borrowerStory; }
                ctx.fillText(b1T, 70, contentStart + 45);
                ctx.fillStyle = "#334155"; wrapText(ctx, b1Txt, 70, contentStart + 85, 420, 24, "Roboto", 6);

                ctx.fillStyle = "#FFFFFF"; ctx.shadowColor = "rgba(0,0,0,0.05)"; ctx.shadowBlur = 10;
                ctx.roundRect(560, contentStart, 480, 300, 15); ctx.fill(); ctx.shadowBlur = 0;

                // Right Box Content
                if (state.template === 'purchase') {
                    ctx.fillStyle = "#f59e0b"; ctx.font = "24px FontAwesome"; ctx.fillText("\uf005", 590, contentStart + 45); 
                    ctx.fillStyle = state.primaryColor; ctx.font = "700 28px Montserrat"; ctx.fillText("PARTNER SHOUTOUT", 630, contentStart + 45);
                    if (state.partnerEnabled) {
                        const pX = 600; const pY = contentStart + 70; const pSize = 120;
                        ctx.save(); ctx.beginPath(); ctx.arc(pX + (pSize/2), pY + (pSize/2), pSize/2, 0, Math.PI * 2); ctx.clip();
                        if (state.images.partner) drawImageCover(ctx, state.images.partner, pX, pY, pSize, pSize);
                        else { ctx.fillStyle = "#e2e8f0"; ctx.fillRect(pX, pY, pSize, pSize); }
                        ctx.restore();
                        const pTextX = pX + pSize + 20; ctx.fillStyle = "#1e293b"; ctx.font = "700 26px Montserrat"; ctx.fillText(state.partnerName, pTextX, pY + 40);
                        ctx.fillStyle = "#64748b"; ctx.font = "500 20px Roboto"; ctx.fillText(state.partnerTitle, pTextX, pY + 70);
                        ctx.fillStyle = "#334155"; wrapText(ctx, `"${state.partnerShoutout}"`, 590, pY + pSize + 25, 420, 22, "italic Roboto", 3);
                    } else { ctx.fillStyle = "#94a3b8"; ctx.font = "italic 24px Roboto"; ctx.fillText("(Partner display disabled)", 630, contentStart + 150); }
                } else if (state.template === 'refinance') {
                    ctx.fillStyle = "#16a34a"; ctx.font = "24px FontAwesome"; ctx.fillText("\uf3d1", 590, contentStart + 45); 
                    ctx.fillStyle = state.primaryColor; ctx.font = "700 28px Montserrat"; ctx.fillText(state.refiTitle.toUpperCase(), 630, contentStart + 45);
                    ctx.fillStyle = "#334155"; wrapText(ctx, state.refiDetails, 590, contentStart + 100, 420, 32, "Roboto", 5);
                } else if (state.template === 'openhouse') {
                    ctx.fillStyle = "#ea580c"; ctx.font = "24px FontAwesome"; ctx.fillText("\uf073", 590, contentStart + 45); 
                    ctx.fillStyle = state.primaryColor; ctx.font = "700 28px Montserrat"; ctx.fillText("WHEN & WHERE", 630, contentStart + 45);
                    const sY = contentStart + 100;
                    ctx.font = "24px FontAwesome"; ctx.fillStyle = state.secondaryColor; ctx.fillText("\uf017", 590, sY);
                    ctx.fillStyle = "#1e293b"; ctx.font = "700 28px Montserrat"; ctx.fillText(state.ohDate, 630, sY);
                    ctx.fillStyle = "#334155"; ctx.font = "500 24px Roboto"; ctx.fillText(state.ohTime, 630, sY + 30);
                    ctx.font = "24px FontAwesome"; ctx.fillStyle = state.secondaryColor; ctx.fillText("\uf3c5", 590, sY + 80);
                    ctx.fillStyle = "#1e293b"; ctx.font = "500 26px Roboto"; wrapText(ctx, state.ohAddress, 630, sY + 80, 380, 26, "Roboto", 2);
                }
            } // End standard social content block

            // --- FOOTER (Common) ---
            const footerY = H - 120;
            ctx.fillStyle = state.primaryColor;
            ctx.fillRect(0, footerY, W, 120);

            if (isFlyer || isOpenHouse) {
                // Partner + Agent Footer (Shared Logic)
                const headshotSize = 100;
                const pHeadshotX = 40;
                const pHeadshotY = footerY + 10;
                
                // Partner Headshot
                ctx.save(); ctx.beginPath(); ctx.arc(pHeadshotX + (headshotSize/2), pHeadshotY + (headshotSize/2), headshotSize/2, 0, Math.PI * 2);
                ctx.lineWidth = 4; ctx.strokeStyle = "#FFFFFF"; ctx.stroke(); ctx.clip();
                if (state.images.partner) drawImageCover(ctx, state.images.partner, pHeadshotX, pHeadshotY, headshotSize, headshotSize);
                else { ctx.fillStyle = "#94a3b8"; ctx.fillRect(pHeadshotX, pHeadshotY, headshotSize, headshotSize); }
                ctx.restore();

                // Partner Text
                ctx.fillStyle = "#FFFFFF"; ctx.textAlign = "left";
                ctx.font = "700 24px Montserrat"; ctx.fillText(state.partnerName, pHeadshotX + 120, footerY + 40);
                ctx.font = "400 18px Roboto"; ctx.fillText(state.partnerTitle, pHeadshotX + 120, footerY + 65);
                ctx.font = "300 16px Roboto"; ctx.fillText(state.partnerContact, pHeadshotX + 120, footerY + 85);

                // Divider
                ctx.beginPath(); ctx.moveTo(W/2, footerY + 10); ctx.lineTo(W/2, footerY + 110);
                ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 1; ctx.stroke();

                // Agent Headshot
                const aHeadshotX = (W/2) + 40;
                ctx.save(); ctx.beginPath(); ctx.arc(aHeadshotX + (headshotSize/2), pHeadshotY + (headshotSize/2), headshotSize/2, 0, Math.PI * 2);
                ctx.lineWidth = 4; ctx.strokeStyle = "#FFFFFF"; ctx.stroke(); ctx.clip();
                if (state.images.agent) drawImageCover(ctx, state.images.agent, aHeadshotX, pHeadshotY, headshotSize, headshotSize);
                else { ctx.fillStyle = "#94a3b8"; ctx.fillRect(aHeadshotX, pHeadshotY, headshotSize, headshotSize); }
                ctx.restore();

                // Agent Text
                ctx.fillStyle = "#FFFFFF"; ctx.textAlign = "left";
                ctx.font = "700 24px Montserrat"; ctx.fillText(state.agentName, aHeadshotX + 120, footerY + 40);
                ctx.font = "400 18px Roboto"; ctx.fillText(state.agentTitle, aHeadshotX + 120, footerY + 65);
                ctx.font = "300 16px Roboto"; ctx.fillText(state.agentContact, aHeadshotX + 120, footerY + 85);

                // Compliance Line
                const compY = footerY + 110;
                const compText = `${state.companyNmls} | Equal Housing Lender`;
                ctx.font = "14px FontAwesome"; ctx.fillStyle = "rgba(255,255,255,0.7)";
                ctx.fillText("\uf015", (W/2) + 40 + 120, compY); 
                ctx.font = "300 12px Roboto";
                ctx.fillText(compText, (W/2) + 40 + 140, compY);

                // --- SOCIAL HANDLES (Flyer Only) ---
                if (isFlyer && (state.socialInsta || state.socialFb || state.socialLi)) {
                    ctx.textAlign = "right"; ctx.fillStyle = "#FFFFFF"; ctx.font = "14px Roboto";
                    const sY = footerY + 110;
                    let sX = W - 40;
                    
                    if(state.socialFb) {
                        ctx.fillText(state.socialFb, sX, sY); sX -= (ctx.measureText(state.socialFb).width + 10);
                        ctx.font = "16px FontAwesome"; ctx.fillText("\uf09a", sX, sY); sX -= 30; // FB Icon
                        ctx.font = "14px Roboto";
                    }
                    if(state.socialInsta) {
                        ctx.fillText(state.socialInsta, sX, sY); sX -= (ctx.measureText(state.socialInsta).width + 10);
                        ctx.font = "16px FontAwesome"; ctx.fillText("\uf16d", sX, sY); sX -= 30; // IG Icon
                        ctx.font = "14px Roboto";
                    }
                    if(state.socialLi) {
                        ctx.fillText(state.socialLi, sX, sY); sX -= (ctx.measureText(state.socialLi).width + 10);
                        ctx.font = "16px FontAwesome"; ctx.fillText("\uf08c", sX, sY); // LI Icon
                        ctx.font = "14px Roboto";
                    }
                }

            } else {
                // Standard Solo Agent Footer
                const headshotSize = 200; const headshotX = 60; const headshotY = footerY - 80; 
                ctx.save(); ctx.beginPath(); ctx.arc(headshotX + (headshotSize/2), headshotY + (headshotSize/2), headshotSize/2, 0, Math.PI * 2);
                ctx.lineWidth = 8; ctx.strokeStyle = "#FFFFFF"; ctx.stroke(); ctx.clip();
                if (state.images.agent) drawImageCover(ctx, state.images.agent, headshotX, headshotY, headshotSize, headshotSize);
                else { ctx.fillStyle = "#94a3b8"; ctx.fillRect(headshotX, headshotY, headshotSize, headshotSize); }
                ctx.restore();

                ctx.fillStyle = "#FFFFFF"; ctx.textAlign = "left";
                ctx.font = "500 32px Montserrat"; ctx.fillText("Ready for your seamless journey?", 300, footerY + 44);
                ctx.font = "300 24px Roboto"; ctx.fillText(state.agentContact, 300, footerY + 74);
                const iconX = 300; const iconY = footerY + 98;
                ctx.font = "18px FontAwesome"; ctx.fillStyle = "#FFFFFF"; ctx.fillText("\uf015", iconX, iconY);
                ctx.font = "300 15px Roboto"; ctx.fillStyle = "rgba(255,255,255,0.9)"; ctx.fillText(`Equal Housing Lender  |  ${state.companyNmls}`, iconX + 30, iconY);
                ctx.fillStyle = "#FFFFFF"; ctx.textAlign = "right"; ctx.font = "40px FontAwesome"; ctx.fillText("\uf095", 1020, footerY + 75); 
            }
        }

        const templateSelect = document.getElementById('templateSelect');
        templateSelect.addEventListener('change', (e) => {
            state.template = e.target.value;
            updateUIForTemplate();
            drawPost();
        });

        // Add Calculator Input Listeners
        const calcInputs = ['calcPrice', 'calcHoa', 'calcTax', 'calcIns', 'sc1Label', 'sc1Down', 'sc1Rate', 'sc2Label', 'sc2Down', 'sc2Rate', 'calcDisclaimer'];
        calcInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = e.target.value;
                // Parse numbers for calc logic
                state[id] = (id.includes('Label') || id === 'calcDisclaimer') ? val : parseFloat(val) || 0;
                drawPost();
            });
        });

        const textInputs = ['agentName', 'agentTitle', 'agentContact', 'companyNmls', 'socialInsta', 'socialFb', 'socialLi', 'statusText', 'borrowerStory', 'partnerName', 'partnerTitle', 'partnerContact', 'partnerShoutout', 'refiTitle', 'refiDetails', 'propertyDesc', 'ohDate', 'ohTime', 'ohAddress'];
        textInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                state[id] = e.target.value;
                drawPost();
            });
            if(['agentName', 'agentTitle', 'agentContact', 'companyNmls', 'socialInsta', 'socialFb', 'socialLi'].includes(id)) {
                document.getElementById(id).addEventListener('blur', saveProfile);
            }
        });

        document.getElementById('socialCaption').addEventListener('input', (e) => {
            state.socialCaption = e.target.value;
        });

        function updateUIForTemplate() {
            const t = state.template;
            
            const purchaseInputs = document.getElementById('partnerInputs');
            const refiInputs = document.getElementById('refiInputs');
            const ohInputs = document.getElementById('openHouseInputs');
            const storyGroup = document.getElementById('storyInputGroup');
            const ohDescGroup = document.getElementById('openHouseDescGroup');
            const calcInputs = document.getElementById('calcInputs');
            const storyLabel = document.getElementById('storyLabel');

            purchaseInputs.classList.add('hidden-group');
            refiInputs.classList.add('hidden-group');
            ohInputs.classList.add('hidden-group');
            storyGroup.classList.add('hidden-group');
            ohDescGroup.classList.add('hidden-group');
            calcInputs.classList.add('hidden-group');

            if (t === 'purchase') {
                purchaseInputs.classList.remove('hidden-group');
                storyGroup.classList.remove('hidden-group');
                storyLabel.innerText = "Borrower Story";
                if (['REFINANCED!', 'OPEN HOUSE'].includes(state.statusText)) { state.statusText = "JUST CLOSED!"; document.getElementById('statusText').value = "JUST CLOSED!"; }
            } 
            else if (t === 'refinance') {
                refiInputs.classList.remove('hidden-group');
                storyGroup.classList.remove('hidden-group');
                storyLabel.innerText = "Financial Goal";
                if (['JUST CLOSED!', 'OPEN HOUSE'].includes(state.statusText)) { state.statusText = "REFINANCED!"; document.getElementById('statusText').value = "REFINANCED!"; }
            } 
            else if (t === 'openhouse') {
                purchaseInputs.classList.remove('hidden-group');
                ohInputs.classList.remove('hidden-group');
                ohDescGroup.classList.remove('hidden-group');
                if (['JUST CLOSED!', 'REFINANCED!'].includes(state.statusText)) { state.statusText = "OPEN HOUSE"; document.getElementById('statusText').value = "OPEN HOUSE"; }
            }
            else if (t === 'flyer') {
                purchaseInputs.classList.remove('hidden-group');
                ohInputs.classList.remove('hidden-group');
                ohDescGroup.classList.remove('hidden-group');
                calcInputs.classList.remove('hidden-group'); // Show Calculator
                // Flyer doesn't use borrower story, uses Calc instead
                if (['JUST CLOSED!', 'REFINANCED!'].includes(state.statusText)) { state.statusText = "OPEN HOUSE"; document.getElementById('statusText').value = "OPEN HOUSE"; }
            }
        }

        // --- SOCIAL SHARE LOGIC (NEW) ---
        document.getElementById('shareBtn').addEventListener('click', async () => {
            if (!navigator.share) {
                alert("Native sharing is not supported on this device/browser. Please use 'Download Image'.");
                return;
            }

            canvas.toBlob(async (blob) => {
                const file = new File([blob], `post-${Date.now()}.png`, { type: "image/png" });
                const shareData = {
                    files: [file],
                    title: 'New Post' // Removed text property to fix Instagram share issue
                };

                try {
                    await navigator.share(shareData);
                    showToast("Shared successfully!");
                } catch (err) {
                    console.log("Share failed or canceled", err);
                }
            });
        });

        document.getElementById('copyCaptionBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(state.socialCaption).then(() => {
                showToast("Caption Copied!");
            }, () => {
                showToast("Failed to copy caption.");
            });
        });


        // --- PARTNER HUB LOGIC ---
        const PARTNERS_KEY = 'mortgage_builder_partners';
        let savedPartners = [];

        function loadPartners() {
            const stored = safeStorage.getItem(PARTNERS_KEY);
            if (stored) {
                try {
                    savedPartners = JSON.parse(stored);
                    updatePartnerDropdown();
                } catch(e) { console.error("Error loading partners", e); }
            }
        }

        function updatePartnerDropdown() {
            const select = document.getElementById('savedPartnerSelect');
            select.innerHTML = '<option value="">Select a saved partner...</option>';
            savedPartners.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = p.name + (p.title ? ` (${p.title})` : '');
                select.appendChild(opt);
            });
        }

        async function savePartnerToHub() {
            const name = document.getElementById('partnerName').value;
            if (!name) { showToast("Please enter a partner name first."); return; }

            let photoData = null;
            let logoData = null;

            if (state.images.partner && state.images.partner.src.startsWith('data:')) {
                photoData = state.images.partner.src;
            }
            if (state.images.partnerLogo && state.images.partnerLogo.src.startsWith('data:')) {
                logoData = state.images.partnerLogo.src;
            }

            const newPartner = {
                name: name,
                title: document.getElementById('partnerTitle').value,
                contact: document.getElementById('partnerContact').value,
                shoutout: document.getElementById('partnerShoutout').value,
                photo: photoData,
                logo: logoData
            };

            const existingIndex = savedPartners.findIndex(p => p.name === name);
            if (existingIndex >= 0) {
                if(confirm(`Update existing partner "${name}"?`)) {
                    savedPartners[existingIndex] = newPartner;
                } else return;
            } else {
                savedPartners.push(newPartner);
            }

            try {
                safeStorage.setItem(PARTNERS_KEY, JSON.stringify(savedPartners));
                showToast(`Partner "${name}" saved to Hub!`);
                updatePartnerDropdown();
            } catch (e) {
                showToast("Error: Storage full. Try using smaller images.");
            }
        }

        function deletePartner() {
            const select = document.getElementById('savedPartnerSelect');
            const idx = select.value;
            if (idx === "") return;
            
            if (confirm("Remove this partner from your list?")) {
                savedPartners.splice(idx, 1);
                safeStorage.setItem(PARTNERS_KEY, JSON.stringify(savedPartners));
                updatePartnerDropdown();
                document.getElementById('deletePartnerBtn').classList.add('hidden');
                showToast("Partner removed.");
            }
        }

        async function onPartnerSelect(e) {
            const idx = e.target.value;
            const deleteBtn = document.getElementById('deletePartnerBtn');
            
            if (idx === "") {
                deleteBtn.classList.add('hidden');
                return;
            }

            deleteBtn.classList.remove('hidden');
            const p = savedPartners[idx];
            
            document.getElementById('partnerName').value = p.name;
            document.getElementById('partnerTitle').value = p.title || '';
            document.getElementById('partnerContact').value = p.contact || '';
            document.getElementById('partnerShoutout').value = p.shoutout || '';

            state.partnerName = p.name;
            state.partnerTitle = p.title || '';
            state.partnerContact = p.contact || '';
            state.partnerShoutout = p.shoutout || '';

            if (p.photo) {
                state.images.partner = await loadImage(p.photo);
            } else {
                state.images.partner = await loadImage(defaultPartnerPhoto);
            }

            if (p.logo) {
                state.images.partnerLogo = await loadImage(p.logo);
            } else {
                state.images.partnerLogo = null;
            }

            document.getElementById('partnerPhotoInput').value = '';
            document.getElementById('partnerLogoInput').value = '';

            drawPost();
            showToast(`Loaded ${p.name}`);
        }

        document.getElementById('savePartnerBtn').addEventListener('click', savePartnerToHub);
        document.getElementById('savedPartnerSelect').addEventListener('change', onPartnerSelect);
        document.getElementById('deletePartnerBtn').addEventListener('click', deletePartner);


        // --- AGENT/TEAM HUB LOGIC ---
        const AGENTS_KEY = 'mortgage_builder_agents';
        let savedAgents = [];

        function loadAgents() {
            const stored = safeStorage.getItem(AGENTS_KEY);
            if (stored) {
                try {
                    savedAgents = JSON.parse(stored);
                    updateAgentDropdown();
                } catch(e) { console.error("Error loading agents", e); }
            }
        }

        function updateAgentDropdown() {
            const select = document.getElementById('savedAgentSelect');
            select.innerHTML = '<option value="">Select a team member...</option>';
            savedAgents.forEach((a, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = a.name;
                select.appendChild(opt);
            });
        }

        async function saveAgentToHub() {
            const name = document.getElementById('agentName').value;
            if (!name) { showToast("Please enter your name first."); return; }

            let photoData = null;
            let logoData = null;

            if (state.images.agent && state.images.agent.src.startsWith('data:')) {
                photoData = state.images.agent.src;
            }
            if (state.images.logo && state.images.logo.src.startsWith('data:')) {
                logoData = state.images.logo.src;
            }

            const newAgent = {
                name: name,
                title: document.getElementById('agentTitle').value,
                contact: document.getElementById('agentContact').value,
                companyNmls: document.getElementById('companyNmls').value,
                socialInsta: document.getElementById('socialInsta').value,
                socialFb: document.getElementById('socialFb').value,
                socialLi: document.getElementById('socialLi').value,
                primaryColor: state.primaryColor,
                secondaryColor: state.secondaryColor,
                photo: photoData,
                logo: logoData
            };

            const existingIndex = savedAgents.findIndex(a => a.name === name);
            if (existingIndex >= 0) {
                if(confirm(`Update existing profile for "${name}"?`)) {
                    savedAgents[existingIndex] = newAgent;
                } else return;
            } else {
                savedAgents.push(newAgent);
            }

            try {
                safeStorage.setItem(AGENTS_KEY, JSON.stringify(savedAgents));
                showToast(`Profile "${name}" saved to Team Hub!`);
                updateAgentDropdown();
            } catch (e) {
                showToast("Error: Storage full. Try using smaller images.");
            }
        }

        function deleteAgent() {
            const select = document.getElementById('savedAgentSelect');
            const idx = select.value;
            if (idx === "") return;
            
            if (confirm("Remove this profile from the list?")) {
                savedAgents.splice(idx, 1);
                safeStorage.setItem(AGENTS_KEY, JSON.stringify(savedAgents));
                updateAgentDropdown();
                document.getElementById('deleteAgentBtn').classList.add('hidden');
                showToast("Profile removed.");
            }
        }

        async function onAgentSelect(e) {
            const idx = e.target.value;
            const deleteBtn = document.getElementById('deleteAgentBtn');
            
            if (idx === "") {
                deleteBtn.classList.add('hidden');
                return;
            }

            deleteBtn.classList.remove('hidden');
            const a = savedAgents[idx];
            
            document.getElementById('agentName').value = a.name;
            document.getElementById('agentTitle').value = a.title || '';
            document.getElementById('agentContact').value = a.contact || '';
            document.getElementById('companyNmls').value = a.companyNmls || '';
            document.getElementById('socialInsta').value = a.socialInsta || '';
            document.getElementById('socialFb').value = a.socialFb || '';
            document.getElementById('socialLi').value = a.socialLi || '';
            document.getElementById('primaryColor').value = a.primaryColor || '#0d3b66';
            document.getElementById('secondaryColor').value = a.secondaryColor || '#8d99ae';

            state.agentName = a.name;
            state.agentTitle = a.title || '';
            state.agentContact = a.contact || '';
            state.companyNmls = a.companyNmls || '';
            state.socialInsta = a.socialInsta || '';
            state.socialFb = a.socialFb || '';
            state.socialLi = a.socialLi || '';
            state.primaryColor = a.primaryColor || '#0d3b66';
            state.secondaryColor = a.secondaryColor || '#8d99ae';

            if (a.photo) {
                state.images.agent = await loadImage(a.photo);
                document.getElementById('agentPhotoSaved').classList.remove('hidden');
            } else {
                state.images.agent = await loadImage(defaultAgentPhoto);
                document.getElementById('agentPhotoSaved').classList.add('hidden');
            }

            if (a.logo) {
                state.images.logo = await loadImage(a.logo);
                document.getElementById('logoSaved').classList.remove('hidden');
            } else {
                if(SAVED_LOGO_SRC) state.images.logo = await loadImage(SAVED_LOGO_SRC);
                else state.images.logo = null;
                
                if(!state.images.logo) document.getElementById('logoSaved').classList.add('hidden');
            }

            document.getElementById('agentPhotoInput').value = '';
            document.getElementById('logoInput').value = '';

            drawPost();
            showToast(`Loaded profile: ${a.name}`);
            saveProfile();
        }

        document.getElementById('saveAgentBtn').addEventListener('click', saveAgentToHub);
        document.getElementById('savedAgentSelect').addEventListener('change', onAgentSelect);
        document.getElementById('deleteAgentBtn').addEventListener('click', deleteAgent);


        const STORAGE_KEY = 'mortgage_builder_profile';

        function saveProfile() {
            const profileData = {
                primaryColor: state.primaryColor,
                secondaryColor: state.secondaryColor,
                agentName: state.agentName,
                agentTitle: state.agentTitle,
                agentContact: state.agentContact,
                companyNmls: state.companyNmls,
                socialInsta: state.socialInsta,
                socialFb: state.socialFb,
                socialLi: state.socialLi,
                agentImage: state.images.agent && state.images.agent.src.startsWith('data:') ? state.images.agent.src : null,
                logoImage: state.images.logo && state.images.logo.src.startsWith('data:') ? state.images.logo.src : null
            };
            safeStorage.setItem(STORAGE_KEY, JSON.stringify(profileData));
        }

        async function loadProfile() {
            const saved = safeStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if(data.agentName) { document.getElementById('agentName').value = data.agentName; state.agentName = data.agentName; }
                    if(data.agentTitle) { document.getElementById('agentTitle').value = data.agentTitle; state.agentTitle = data.agentTitle; }
                    if(data.agentContact) { document.getElementById('agentContact').value = data.agentContact; state.agentContact = data.agentContact; }
                    if(data.companyNmls) { document.getElementById('companyNmls').value = data.companyNmls; state.companyNmls = data.companyNmls; }
                    if(data.socialInsta) { document.getElementById('socialInsta').value = data.socialInsta; state.socialInsta = data.socialInsta; }
                    if(data.socialFb) { document.getElementById('socialFb').value = data.socialFb; state.socialFb = data.socialFb; }
                    if(data.socialLi) { document.getElementById('socialLi').value = data.socialLi; state.socialLi = data.socialLi; }
                    if(data.primaryColor) { document.getElementById('primaryColor').value = data.primaryColor; state.primaryColor = data.primaryColor; }
                    if(data.secondaryColor) { document.getElementById('secondaryColor').value = data.secondaryColor; state.secondaryColor = data.secondaryColor; }
                    if (data.agentImage) { 
                        try { state.images.agent = await loadImage(data.agentImage); document.getElementById('agentPhotoSaved').classList.remove('hidden'); } catch(e) {} 
                    }
                    if (data.logoImage) { 
                        try { state.images.logo = await loadImage(data.logoImage); document.getElementById('logoSaved').classList.remove('hidden'); } catch(e) {} 
                    }
                } catch(err) { console.error("Error loading profile", err); }
            }
        }

        document.getElementById('clearProfileBtn').addEventListener('click', () => {
            if(confirm("Reset all fields to default?")) { 
                safeStorage.removeItem(STORAGE_KEY); 
                location.reload(); 
            }
        });

        async function init() {
            try {
                if (SAVED_AGENT_PHOTO_SRC) {
                    state.images.agent = await loadImage(SAVED_AGENT_PHOTO_SRC);
                    document.getElementById('agentPhotoSaved').classList.remove('hidden'); 
                }
                if (SAVED_LOGO_SRC) {
                    state.images.logo = await loadImage(SAVED_LOGO_SRC);
                    document.getElementById('logoSaved').classList.remove('hidden'); 
                }
                
                await loadProfile();
                loadPartners(); 
                loadAgents(); 
                
                if (!state.images.agent) state.images.agent = await loadImage(defaultAgentPhoto);
                if (!state.images.partner) state.images.partner = await loadImage(defaultPartnerPhoto); 
                
                drawPost();
                
                const overlay = document.getElementById('loading-overlay');
                if(overlay) overlay.classList.add('hidden');
                
            } catch (e) {
                console.error("Init failed:", e);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        setTimeout(() => {
            const loader = document.getElementById('loading-overlay');
            if (loader && !loader.classList.contains('hidden')) {
                console.warn("Forcing loader hide via safety timer");
                loader.classList.add('hidden');
            }
        }, 3000);

        ['primaryColor', 'secondaryColor'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                state[id] = e.target.value;
                drawPost();
                saveProfile(); 
            });
        });

        document.getElementById('partnerToggle').addEventListener('change', (e) => {
            state.partnerEnabled = e.target.checked;
            const controls = document.getElementById('partnerControls');
            state.partnerEnabled ? controls.classList.remove('opacity-50', 'pointer-events-none') : controls.classList.add('opacity-50', 'pointer-events-none');
            drawPost();
        });

        function handleImageUpload(inputId, stateKey, saveToProfile = false) {
            document.getElementById(inputId).addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const img = new Image();
                        img.onload = () => {
                            state.images[stateKey] = img;
                            drawPost();
                            if (saveToProfile) {
                                if (inputId === 'agentPhotoInput') document.getElementById('agentPhotoSaved').classList.remove('hidden');
                                if (inputId === 'logoInput') document.getElementById('logoSaved').classList.remove('hidden');
                                saveProfile();
                            }
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        }

        handleImageUpload('agentPhotoInput', 'agent', true);
        handleImageUpload('logoInput', 'logo', true);
        handleImageUpload('mainPhotoInput', 'main', false);
        handleImageUpload('partnerPhotoInput', 'partner', false);
        handleImageUpload('partnerLogoInput', 'partnerLogo', false);

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const dataUrl = canvas.toDataURL();
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                finalImage.src = dataUrl;
                saveModal.classList.add('active');
            } else {
                const link = document.createElement('a');
                link.download = `Mortgage-Post-${state.template}-${Date.now()}.png`;
                link.href = dataUrl;
                link.click();
                showToast("Image Downloaded!");
            }
        });

        closeModalBtn.addEventListener('click', () => {
            saveModal.classList.remove('active');
        });

        saveModal.addEventListener('click', (e) => {
            if(e.target === saveModal) saveModal.classList.remove('active');
        });

        document.getElementById('saveToolBtn').addEventListener('click', () => {
            showToast("Preparing Config File...");
            let htmlContent = document.documentElement.outerHTML;
            const scriptTagMatch = htmlContent.match(/<script>(.*?)<\/script>/s);
            if (!scriptTagMatch || !scriptTagMatch[1]) {
                showToast("Error: Could not save tool.");
                return;
            }
            let scriptContent = scriptTagMatch[1];
            const currentAgentSrc = state.images.agent && state.images.agent.src.startsWith('data:') ? state.images.agent.src : '';
            const currentLogoSrc = state.images.logo && state.images.logo.src.startsWith('data:') ? state.images.logo.src : '';
            const agentPhotoRegex = /(const SAVED_AGENT_PHOTO_SRC = ')(.*?)(';)/s;
            const logoRegex = /(const SAVED_LOGO_SRC = ')(.*?)(';)/s;
            scriptContent = scriptContent.replace(agentPhotoRegex, `$1${currentAgentSrc}$3`);
            scriptContent = scriptContent.replace(logoRegex, `$1${currentLogoSrc}$3`);
            const scriptTagFull = scriptTagMatch[0].replace(scriptTagMatch[1], scriptContent);
            htmlContent = htmlContent.replace(scriptTagMatch[0], scriptTagFull);
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.download = 'Ben_Harman_Marketing_Hub_Custom.html';
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast("Tool Saved! Use the new file for future posts.");
        });

        setTimeout(init, 100);
    })(); 
</script>
</body>
</html>
